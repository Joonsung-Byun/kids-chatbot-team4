version: '3.8'

services:
  # ChromaDB 로컬 서버
  chromadb:
    image: chromadb/chroma:latest
    container_name: kids-chatbot-chromadb
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_data:/chroma/chroma  # 데이터 영속성
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chatbot-network

  # Backend API (CPU 버전)
  backend-cpu:
    build:
      context: ./backend
      dockerfile: Dockerfile.cpu
    container_name: kids-chatbot-backend-cpu
    ports:
      - "3001:3001"
    volumes:
      - ./backend:/app
      - ./backend/data:/app/data
    environment:
      # ChromaDB 연결 (로컬 서버)
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - CHROMA_COLLECTION_NAME=kid_program_collection
      
      # API Keys (환경변수나 .env에서 로드)
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
      
      # 실행 환경
      - ENVIRONMENT=docker
      - USE_GPU=false
      - DEBUG=true
      - PORT=3001
    depends_on:
      chromadb:
        condition: service_healthy
    networks:
      - chatbot-network
    command: uvicorn main:app --host 0.0.0.0 --port 3001 --reload

  # Backend API (GPU 버전) - 선택적 사용
  backend-gpu:
    build:
      context: ./backend
      dockerfile: Dockerfile.gpu
    container_name: kids-chatbot-backend-gpu
    ports:
      - "3002:3001"
    volumes:
      - ./backend:/app
      - ./backend/data:/app/data
    environment:
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - CHROMA_COLLECTION_NAME=kid_program_collection
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENVIRONMENT=docker
      - USE_GPU=true
      - DEBUG=true
      - PORT=3001
    depends_on:
      chromadb:
        condition: service_healthy
    networks:
      - chatbot-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: uvicorn main:app --host 0.0.0.0 --port 3001 --reload
    profiles:
      - gpu  # GPU 프로파일 (명시적으로 활성화 필요)

networks:
  chatbot-network:
    driver: bridge

volumes:
  chroma_data:
    driver: local